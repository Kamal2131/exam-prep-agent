<!DOCTYPE html>
<html>
<head>
    <title>Exam Prep Agent - Advanced Workflow</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; }
        .upload-area { border: 2px dashed #007bff; padding: 30px; text-align: center; margin: 20px 0; border-radius: 10px; }
        button { background: #007bff; color: white; padding: 12px 24px; border: none; cursor: pointer; margin: 8px; border-radius: 5px; }
        button:hover { background: #0056b3; }
        .status { padding: 15px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        .quiz-question { background: #f8f9fa; padding: 20px; margin: 15px 0; border-radius: 8px; border-left: 4px solid #007bff; }
        .results { background: #e7f3ff; padding: 20px; border-radius: 8px; margin: 20px 0; }
        .agent-health { display: flex; gap: 20px; margin: 20px 0; }
        .agent-card { flex: 1; padding: 15px; border-radius: 8px; text-align: center; }
        .healthy { background: #d4edda; color: #155724; }
        .unhealthy { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container">
        <div id="auth-section">
            <div id="login-section">
                <h1>üéì Advanced Exam Prep Agent</h1>
                <p>Sign in with Google to start creating AI-powered exams</p>
                <div id="g_id_onload"
                     data-client_id="800873427903-rifl1ht0f49n7aiu5vec7fhkbe7l0a37.apps.googleusercontent.com"
                     data-callback="handleCredentialResponse">
                </div>
                <div class="g_id_signin" data-type="standard"></div>
            </div>
            
            <div id="app-section" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div>
                        <h1>üéì Advanced Exam Prep Agent</h1>
                        <p>LangGraph Workflow with Supervisor Agent & Specialized Math/General Agents</p>
                    </div>
                    <div id="user-info" style="text-align: right;">
                        <img id="user-avatar" style="width: 40px; height: 40px; border-radius: 50%; margin-right: 10px;">
                        <span id="user-name"></span>
                        <button onclick="logout()" style="margin-left: 10px; background: #dc3545;">Logout</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Agent Health Status -->
        <div id="agent-health" class="agent-health" style="display: none;">
            <div class="agent-card" id="supervisor-status">
                <h4>Supervisor Agent</h4>
                <div id="supervisor-health">Checking...</div>
            </div>
            <div class="agent-card" id="math-status">
                <h4>Math Agent</h4>
                <div id="math-health">Checking...</div>
            </div>
            <div class="agent-card" id="general-status">
                <h4>General Agent</h4>
                <div id="general-health">Checking...</div>
            </div>
        </div>
        
        <!-- Upload Section -->
        <div class="upload-area" id="upload-section">
            <h3>üìö Upload Syllabus for AI-Powered Exam Prep</h3>
            <input type="file" id="syllabusFile" accept=".pdf,.txt">
            <button onclick="runWorkflow()">üöÄ Run Complete Workflow</button>
            <button onclick="checkAgentHealth()">üè• Check Agent Health</button>
        </div>
        
        <!-- Results Section -->
        <div id="results"></div>
        
        <!-- Quiz Section -->
        <div id="quiz-container" style="display: none;">
            <h2>üìù Take Your Exam</h2>
            <div id="quiz-questions"></div>
            <button onclick="submitExam()" id="submit-btn" style="display: none;">üìä Submit Exam</button>
        </div>
        
        <!-- Exam Results -->
        <div id="exam-results"></div>
    </div>
    
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script>
        let currentSyllabusId = null;
        let quizQuestions = [];
        let authToken = localStorage.getItem('authToken');
        
        // Google OAuth callback
        function handleCredentialResponse(response) {
            console.log('Google credential received');
            fetch('/api/auth/google', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token: response.credential })
            })
            .then(res => res.json())
            .then(data => {
                console.log('Auth response:', data);
                if (data.access_token) {
                    authToken = data.access_token;
                    localStorage.setItem('authToken', authToken);
                    console.log('Token stored:', authToken.substring(0, 20) + '...');
                    showApp(data.user);
                } else {
                    console.error('No access token received:', data);
                }
            })
            .catch(err => {
                console.error('Login error:', err);
                alert('Login failed: ' + err.message);
            });
        }
        
        function showApp(user) {
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('app-section').style.display = 'block';
            document.getElementById('upload-section').style.display = 'block';
            document.getElementById('user-name').textContent = user.name;
            document.getElementById('user-avatar').src = user.picture;
        }
        
        function logout() {
            localStorage.removeItem('authToken');
            authToken = null;
            document.getElementById('login-section').style.display = 'block';
            document.getElementById('app-section').style.display = 'none';
            document.getElementById('upload-section').style.display = 'none';
        }
        
        // Check if user is already logged in
        async function checkAuth() {
            if (authToken) {
                try {
                    const response = await fetch('/api/auth/me', {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });
                    if (response.ok) {
                        const user = await response.json();
                        showApp(user);
                    } else {
                        logout();
                    }
                } catch {
                    logout();
                }
            }
        }
        
        async function checkAgentHealth() {
            try {
                const response = await fetch('/api/workflow/agent-health');
                const result = await response.json();
                
                document.getElementById('agent-health').style.display = 'flex';
                
                const health = result.health_check;
                
                // Update supervisor status
                document.getElementById('supervisor-health').innerHTML = 
                    `<strong>${health.supervisor_status}</strong><br>Managing ${health.total_agents} agents`;
                
                // Update agent statuses
                const agents = health.agents_health;
                for (const [agentName, status] of Object.entries(agents)) {
                    const element = document.getElementById(`${agentName}-health`);
                    const card = document.getElementById(`${agentName}-status`);
                    
                    if (element && card) {
                        element.innerHTML = `<strong>${status.status}</strong><br>${status.capabilities?.join(', ') || 'N/A'}`;
                        card.className = `agent-card ${status.status === 'healthy' ? 'healthy' : 'unhealthy'}`;
                    }
                }
                
            } catch (error) {
                console.error('Health check failed:', error);
            }
        }
        
        async function runWorkflow() {
            if (!authToken) {
                alert('Please sign in with Google first');
                return;
            }
            
            const fileInput = document.getElementById('syllabusFile');
            const file = fileInput.files[0];
            if (!file) {
                alert('Please select a file first');
                return;
            }
            
            try {
                // Step 1: Upload syllabus
                document.getElementById('results').innerHTML = 
                    '<div class="status info">üîÑ Step 1: Uploading syllabus...</div>';
                
                const formData = new FormData();
                formData.append('file', file);
                
                const headers = {};
                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                    console.log('Sending auth header:', authToken.substring(0, 20) + '...');
                } else {
                    console.error('No auth token available');
                }
                
                const uploadResponse = await fetch('/api/syllabus/upload', {
                    method: 'POST',
                    headers: headers,
                    body: formData
                });
                
                if (!uploadResponse.ok) {
                    throw new Error('Failed to upload syllabus');
                }
                
                const uploadResult = await uploadResponse.json();
                currentSyllabusId = uploadResult.id;
                
                // Step 2: Run complete workflow
                document.getElementById('results').innerHTML += 
                    '<div class="status info">üîÑ Step 2: Running LangGraph workflow with supervisor delegation...</div>';
                
                const workflowResponse = await fetch(`/api/workflow/prepare-exam/${currentSyllabusId}`, {
                    method: 'POST',
                    headers: authToken ? { 'Authorization': `Bearer ${authToken}` } : {}
                });
                
                const workflowResult = await workflowResponse.json();
                
                if (workflowResult.status === 'success') {
                    document.getElementById('results').innerHTML = `
                        <div class="status success">
                            <h3>‚úÖ Workflow Complete!</h3>
                            <p><strong>Topics Extracted:</strong> ${workflowResult.topics.join(', ')}</p>
                            <p><strong>MCQs Generated:</strong> ${workflowResult.mcqs_generated}</p>
                            <p><strong>Quiz Questions:</strong> ${workflowResult.quiz_questions}</p>
                            <p><strong>Agents Health:</strong> ${workflowResult.agent_health.healthy_agents}/${workflowResult.agent_health.total_agents} healthy</p>
                        </div>
                        <button onclick="startExam()" style="font-size: 18px; padding: 15px 30px;">üéØ Start Exam</button>
                    `;
                } else {
                    document.getElementById('results').innerHTML = 
                        `<div class="status error">‚ùå Workflow failed: ${workflowResult.error}</div>`;
                }
                
            } catch (error) {
                document.getElementById('results').innerHTML = 
                    `<div class="status error">‚ùå Error: ${error.message}</div>`;
            }
        }
        
        async function startExam() {
            try {
                const response = await fetch(`/api/workflow/quiz/${currentSyllabusId}`, {
                    headers: authToken ? { 'Authorization': `Bearer ${authToken}` } : {}
                });
                const result = await response.json();
                
                quizQuestions = result.quiz_questions;
                displayQuiz(quizQuestions);
                
            } catch (error) {
                alert('Failed to load quiz: ' + error.message);
            }
        }
        
        function displayQuiz(questions) {
            document.getElementById('quiz-container').style.display = 'block';
            
            let questionsHtml = '';
            questions.forEach((q, index) => {
                questionsHtml += `
                    <div class="quiz-question">
                        <h4>Question ${index + 1}: [${q.topic}]</h4>
                        <p><strong>${q.question}</strong></p>
                        <div style="margin: 10px 0;">
                            <label><input type="radio" name="q${q.id}" value="A"> A) ${q.option_a}</label><br>
                            <label><input type="radio" name="q${q.id}" value="B"> B) ${q.option_b}</label><br>
                            <label><input type="radio" name="q${q.id}" value="C"> C) ${q.option_c}</label><br>
                            <label><input type="radio" name="q${q.id}" value="D"> D) ${q.option_d}</label>
                        </div>
                    </div>`;
            });
            
            document.getElementById('quiz-questions').innerHTML = questionsHtml;
            document.getElementById('submit-btn').style.display = 'block';
        }
        
        async function submitExam() {
            if (!currentSyllabusId) return;
            
            const answers = {};
            quizQuestions.forEach(q => {
                const selected = document.querySelector(`input[name="q${q.id}"]:checked`);
                if (selected) {
                    answers[q.id] = selected.value;
                }
            });
            
            try {
                const headers = { 'Content-Type': 'application/json' };
                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }
                
                const response = await fetch(`/api/workflow/submit-exam/${currentSyllabusId}`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({ answers: answers })
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    const examResults = result.results;
                    
                    document.getElementById('exam-results').innerHTML = `
                        <div class="results">
                            <h2>üéâ Exam Results (Supervisor Evaluated)</h2>
                            <div style="display: flex; gap: 30px; margin: 20px 0;">
                                <div><strong>Score:</strong> ${examResults.score_percentage}%</div>
                                <div><strong>Grade:</strong> ${examResults.grade}</div>
                                <div><strong>Correct:</strong> ${examResults.correct_answers}/${examResults.total_questions}</div>
                            </div>
                            <p><strong>Feedback:</strong> ${examResults.feedback}</p>
                            
                            <h3>üìä Detailed Results:</h3>
                            ${examResults.detailed_results.map((r, i) => `
                                <div style="margin: 10px 0; padding: 10px; background: ${r.is_correct ? '#d4edda' : '#f8d7da'}; border-radius: 5px;">
                                    <strong>Q${i+1} [${r.topic}]:</strong> ${r.is_correct ? '‚úÖ' : '‚ùå'}<br>
                                    <small>${r.question}</small><br>
                                    <strong>Your Answer:</strong> ${r.user_answer} | <strong>Correct:</strong> ${r.correct_answer}
                                </div>
                            `).join('')}
                        </div>
                    `;
                    
                    document.getElementById('submit-btn').style.display = 'none';
                }
                
            } catch (error) {
                alert('Failed to submit exam: ' + error.message);
            }
        }
        
        // Auto-check auth and agent health on page load
        window.onload = function() {
            checkAuth();
            checkAgentHealth();
        };
    </script>
</body>
</html>